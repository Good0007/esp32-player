# ESP32-S3 Audio Player

这是一个基于 ESP32-S3 的高性能音频播放器项目，支持多种音频格式、目录播放模式、播放列表持久化缓存以及断电记忆功能。

## ✨ 主要功能

*   **多格式支持**：支持 MP3, AAC, FLAC, OGG, WAV 等主流音频格式。
*   **模式切换**：通过文件夹组织内容（儿歌、古诗、故事、音乐），一键切换播放场景。
*   **极速扫描**：采用目录递归扫描 + 缓存机制（NVS/文件），上千首歌曲秒级加载。
*   **断电记忆**：自动记忆当前播放模式、音量大小及 LED 设置，重启后自动恢复。
*   **智能播放**：
    *   自动跳过并清理不存在的文件。
    *   播放列表随机打乱（Shuffle）。
*   **交互反馈**：
    *   RGB LED 状态指示（播放时彩虹呼吸灯，操作时闪烁反馈）。
    *   多功能按键控制（单击、双击、长按）。

## 🛠 硬件连接

本项目基于 ESP32-S3 开发板（如 DevKitC-1），硬件引脚定义如下（可在 `include/config.h` 中修改）：

| 模块 | 引脚名称 | GPIO 编号 | 说明 |
| :--- | :--- | :--- | :--- |
| **I2S 音频 (MAX98357A)** | BCLK | GPIO 6 | 位时钟 |
| | LRCK | GPIO 7 | 左右声道时钟 |
| | DOUT | GPIO 5 | 数据输出 |
| **SD 卡 (SPI)** | CS | GPIO 10 | 片选 |
| | MOSI | GPIO 11 | 主出从入 |
| | CLK | GPIO 12 | 时钟 |
| | MISO | GPIO 13 | 主入从出 |
| **按键** | Mode (模式) | GPIO 14 | 模式切换/播放暂停 |
| | Vol+ (音量+) | GPIO 9 | 音量加/下一曲 |
| | Vol- (音量-) | GPIO 21 | 音量减/上一曲 |
| **其他** | LED | GPIO 48 | 板载 RGB LED (WS2812) |
| **屏幕 (ST7789V2, SPI)** | BL | GPIO 15 | 背光（PWM 调光） |
| | MOSI | GPIO 18 | 数据输出 |
| | CLK | GPIO 8 | 时钟 |
| | DC | GPIO 16 | 数据/命令选择 |
| | RST | GPIO 17 | 复位 |
| | CS | — | 不接（代码中设为 -1） |

> **注意**：I2S 麦克风接口已在代码中预留定义，但暂未启用。屏幕功能通过编译宏 `ENABLE_DISPLAY` 控制，默认关闭，开启方式见下文。

## 📂 SD 卡目录结构

请在 SD 卡根目录创建以下文件夹，并将对应类型的音频文件放入其中（支持子目录）：

```text
/
├── 儿歌/      <-- 模式 1
├── 古诗/      <-- 模式 2
├── 故事/      <-- 模式 3
└── 音乐/      <-- 模式 4
```

*   支持中文目录和文件名。
*   非音频文件或以 `.` 开头的隐藏文件会被自动忽略。

## 🎮 操作说明

### 按键操作

| 按键 | 动作 | 功能 |
| :--- | :--- | :--- |
| **模式键 (Mode)** | 单击 | 播放 / 暂停 |
| | 双击 | 开启 / 关闭 LED 灯效 |
| | 长按 | 切换分区/系统功能 (预留) |
| **音量+ (Vol+)** | 单击 | 音量增加 |
| | 双击 | **下一首** (Next Song) |
| | 长按 | **下一模式** (Next Mode) |
| **音量- (Vol-)** | 单击 | 音量减少 |
| | 双击 | **上一首** (Prev Song) |
| | 长按 | **上一模式** (Prev Mode) |

### LED 状态指示

*   **开机**：绿色闪烁 3 次。
*   **播放中**：彩虹色呼吸/流光效果。
*   **暂停**：LED 熄灭。
*   **模式切换**：蓝色闪烁 2 次。
*   **LED 开关**：
    *   开启：绿色闪烁 1 次。
    *   关闭：红色闪烁 1 次。

## � 屏幕显示 (可选)

项目支持外接 **ST7789V2 240×240 像素 SPI TFT 屏幕**，通过 [LovyanGFX](https://github.com/lovyan03/LovyanGFX) 库驱动，提供实时播放信息展示。

### 启用屏幕

在 `platformio.ini` 中追加编译宏即可开启屏幕功能：

```ini
build_flags =
    -D ENABLE_DISPLAY
```

> 未定义该宏时，所有屏幕相关代码均被条件编译排除，不影响无屏幕版本运行。

### UI 布局

屏幕分为以下几个区域（坐标以像素为单位，屏幕分辨率 240×240）：

```
┌─────────────────────────────────┐
│  01/42   │  儿歌  │  🔊 18      │  ← 状态栏 (0~23px) 左:曲目序号, 中:模式, 右:音量
├─────────────────────────────────┤
│                                 │
│   ▂ ▅ ▇ ▃ ▆ ▂ ▅ ▇ ▃ ▆ ▂ ▅   │  ← 频谱动画 (40~120px) 16条柱，含峰值保持
│                                 │
│   256 kbps                 MP3  │  ← 码率信息 (130px)
│                                 │
│       小毛驴.mp3                │  ← 歌曲名 (160px，超长自动滚动)
│─────────────────────────────────│
│  ████████████░░░░░░░░░░░░░░░░  │  ← 进度条 (191px)
│  01:23                  03:45  │  ← 播放时间 (210px)
│               ▶/⏸              │  ← 播放状态图标 (212px)
└─────────────────────────────────┘
```

### UI 功能特性

*   **实时频谱动画**：16 条随机仿真频谱柱，含峰值保持效果，约 33fps 刷新。
*   **歌曲名滚动**：文件名超出屏幕宽度时自动平滑横向滚动，首尾各停顿 2 秒。
*   **进度条**：6px 细条样式，实时显示播放进度与已播/总时长。
*   **码率显示**：左侧显示码率（如 `256 kbps`），右侧显示格式（如 `MP3`）。
*   **加载提示**：扫描/加载播放列表时居中显示提示文字。
*   **多主题切换**：内置 3 款主题，可通过代码调用 `ui.nextTheme()` 循环切换。

### 内置主题

| 主题名称 | 背景色 | 文字色 | 高亮色 | 适用场景 |
| :--- | :--- | :--- | :--- | :--- |
| **Classic** | 黑色 | 白色 | 绿色 | 暗光环境 |
| **Blue** | 深蓝 | 白色 | 黄色 | 日常使用 |
| **Light** | 白色 | 黑色 | 红色 | 强光环境 |

### 依赖库

启用屏幕功能需额外在 `platformio.ini` 中添加依赖：

```ini
lib_deps =
    ; ... 其他依赖 ...
    lovyan03/LovyanGFX @ ^1.1.12
```

---

## �🔧 辅助工具

项目包含一个 Python 脚本 `tools/generate_playlist.py`，用于在 PC 端预处理 SD 卡。

**功能**：
1.  生成播放列表索引缓存（加速 ESP32 启动）。
2.  **自动清理**非音频文件（如 `.DS_Store`, `._*` 等垃圾文件）。

**使用方法**：
1.  将 SD 卡插入电脑。
2.  运行脚本：
    ```bash
    # Mac/Linux
    python3 tools/generate_playlist.py /Volumes/YOUR_SD_CARD

    # Windows
    python tools/generate_playlist.py E:\
    ```

## 💻 开发与编译

本项目使用 **PlatformIO** 进行管理。

1.  安装 VS Code 和 PlatformIO 插件。
2.  克隆本项目。
3.  在 PlatformIO 中打开项目文件夹。
4.  连接 ESP32-S3 开发板。
5.  点击底部的 `Build` 编译，或 `Upload` 烧录。

**依赖库**（会自动安装）：
*   `OneButton`: 按键处理。
*   `ESP32-audioI2S`: 音频解码与播放。

## 📝 常见问题

*   **Q: 播放时卡顿？**
    *   A: 检查 SD 卡速度，或尝试在 `main.cpp` 中调整 SPI 频率（默认 16MHz）。已优化为全量扫描+缓存机制，避免后台扫描占用 SPI。
*   **Q: 无法识别 SD 卡？**
    *   A: 确保 SD 卡格式为 FAT32。检查接线是否正确。
*   **Q: 只有杂音？**
    *   A: 检查 I2S DAC 接线，特别是 GND 是否共地。

---

## 📄 开源协议

本项目以 [MIT License](LICENSE) 开源，欢迎自由使用、修改与分发。
