# ESP32-S3 Audio Player

这是一个基于 ESP32-S3 的高性能音频播放器项目，支持多种音频格式、目录播放模式、播放列表持久化缓存以及断电记忆功能。

## ✨ 主要功能

*   **多格式支持**：支持 MP3, AAC, FLAC, OGG, WAV 等主流音频格式。
*   **模式切换**：通过文件夹组织内容（儿歌、古诗、故事、音乐），一键切换播放场景。
*   **极速扫描**：采用目录递归扫描 + 缓存机制（NVS/文件），上千首歌曲秒级加载。
*   **断电记忆**：自动记忆当前播放模式、音量大小及 LED 设置，重启后自动恢复。
*   **智能播放**：
    *   自动跳过并清理不存在的文件。
    *   播放列表随机打乱（Shuffle）。
*   **交互反馈**：
    *   RGB LED 状态指示（播放时彩虹呼吸灯，操作时闪烁反馈）。
    *   多功能按键控制（单击、双击、长按）。

## 🛠 硬件连接

本项目基于 ESP32-S3 开发板（如 DevKitC-1），硬件引脚定义如下（可在 `include/config.h` 中修改）：

| 模块 | 引脚名称 | GPIO 编号 | 说明 |
| :--- | :--- | :--- | :--- |
| **I2S 音频 (MAX98357A)** | BCLK | GPIO 6 | 位时钟 |
| | LRCK | GPIO 7 | 左右声道时钟 |
| | DOUT | GPIO 5 | 数据输出 |
| **SD 卡 (SPI)** | CS | GPIO 10 | 片选 |
| | MOSI | GPIO 11 | 主出从入 |
| | CLK | GPIO 12 | 时钟 |
| | MISO | GPIO 13 | 主入从出 |
| **按键** | Mode (模式) | GPIO 14 | 模式切换/播放暂停 |
| | Vol+ (音量+) | GPIO 9 | 音量加/下一曲 |
| | Vol- (音量-) | GPIO 21 | 音量减/上一曲 |
| **其他** | LED | GPIO 48 | 板载 RGB LED (WS2812) |

> **注意**：I2S 麦克风和屏幕接口已在代码中预留定义，但暂未启用核心功能。

## 📂 SD 卡目录结构

请在 SD 卡根目录创建以下文件夹，并将对应类型的音频文件放入其中（支持子目录）：

```text
/
├── 儿歌/      <-- 模式 1
├── 古诗/      <-- 模式 2
├── 故事/      <-- 模式 3
└── 音乐/      <-- 模式 4
```

*   支持中文目录和文件名。
*   非音频文件或以 `.` 开头的隐藏文件会被自动忽略。

## 🎮 操作说明

### 按键操作

| 按键 | 动作 | 功能 |
| :--- | :--- | :--- |
| **模式键 (Mode)** | 单击 | 播放 / 暂停 |
| | 双击 | 开启 / 关闭 LED 灯效 |
| | 长按 | 切换分区/系统功能 (预留) |
| **音量+ (Vol+)** | 单击 | 音量增加 |
| | 双击 | **下一首** (Next Song) |
| | 长按 | **下一模式** (Next Mode) |
| **音量- (Vol-)** | 单击 | 音量减少 |
| | 双击 | **上一首** (Prev Song) |
| | 长按 | **上一模式** (Prev Mode) |

### LED 状态指示

*   **开机**：绿色闪烁 3 次。
*   **播放中**：彩虹色呼吸/流光效果。
*   **暂停**：LED 熄灭。
*   **模式切换**：蓝色闪烁 2 次。
*   **LED 开关**：
    *   开启：绿色闪烁 1 次。
    *   关闭：红色闪烁 1 次。

## 🔧 辅助工具

项目包含一个 Python 脚本 `tools/generate_playlist.py`，用于在 PC 端预处理 SD 卡。

**功能**：
1.  生成播放列表索引缓存（加速 ESP32 启动）。
2.  **自动清理**非音频文件（如 `.DS_Store`, `._*` 等垃圾文件）。

**使用方法**：
1.  将 SD 卡插入电脑。
2.  运行脚本：
    ```bash
    # Mac/Linux
    python3 tools/generate_playlist.py /Volumes/YOUR_SD_CARD

    # Windows
    python tools/generate_playlist.py E:\
    ```

## 💻 开发与编译

本项目使用 **PlatformIO** 进行管理。

1.  安装 VS Code 和 PlatformIO 插件。
2.  克隆本项目。
3.  在 PlatformIO 中打开项目文件夹。
4.  连接 ESP32-S3 开发板。
5.  点击底部的 `Build` 编译，或 `Upload` 烧录。

**依赖库**（会自动安装）：
*   `OneButton`: 按键处理。
*   `ESP32-audioI2S`: 音频解码与播放。

## 📝 常见问题

*   **Q: 播放时卡顿？**
    *   A: 检查 SD 卡速度，或尝试在 `main.cpp` 中调整 SPI 频率（默认 16MHz）。已优化为全量扫描+缓存机制，避免后台扫描占用 SPI。
*   **Q: 无法识别 SD 卡？**
    *   A: 确保 SD 卡格式为 FAT32。检查接线是否正确。
*   **Q: 只有杂音？**
    *   A: 检查 I2S DAC 接线，特别是 GND 是否共地。

---
Created by Trae AI Assistant
